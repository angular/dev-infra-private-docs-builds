/*!
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.dev/license
 */
import { NgFor, NgIf } from '@angular/common';
import { ChangeDetectionStrategy, Component, DestroyRef, ElementRef, ViewChild, inject, signal, } from '@angular/core';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { MatTabGroup, MatTabsModule } from '@angular/material/tabs';
import { debounceTime, map } from 'rxjs';
import { TerminalType } from '../services/terminal-handler.service';
import { EmbeddedTutorialManager } from '../services/embedded-tutorial-manager.service';
import { CodeMirrorEditor } from './services/code-mirror-editor.service';
import { DiagnosticsState } from './services/diagnostics-state.service';
import { DownloadManager } from '../services/download-manager.service';
import { IconComponent } from '../../components/icon/icon.component';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/tabs";
export const REQUIRED_FILES = new Set(['src/main.ts', 'src/index.html']);
export class CodeEditor {
    constructor() {
        this.destroyRef = inject(DestroyRef);
        this.codeMirrorEditor = inject(CodeMirrorEditor);
        this.diagnosticsState = inject(DiagnosticsState);
        this.downloadManager = inject(DownloadManager);
        this.embeddedTutorialManager = inject(EmbeddedTutorialManager);
        this.errors$ = this.diagnosticsState.diagnostics$.pipe(
        // Display errors one second after code update
        debounceTime(1000), map((diagnosticsItem) => diagnosticsItem
            .filter((item) => item.severity === 'error')
            .sort((a, b) => a.lineNumber != b.lineNumber
            ? a.lineNumber - b.lineNumber
            : a.characterPosition - b.characterPosition)), takeUntilDestroyed(this.destroyRef));
        this.TerminalType = TerminalType;
        this.displayErrorsBox = signal(false);
        this.errors = signal([]);
        this.files = this.codeMirrorEditor.openFiles;
        this.isCreatingFile = signal(false);
    }
    set setFileInputRef(element) {
        if (element) {
            element.nativeElement.focus();
            this.createFileInputRef = element;
        }
    }
    ngAfterViewInit() {
        this.codeMirrorEditor.init(this.codeEditorWrapperRef.nativeElement);
        this.listenToDiagnosticsChange();
        this.listenToTabChange();
        this.setSelectedTabOnTutorialChange();
    }
    ngOnDestroy() {
        this.codeMirrorEditor.disable();
    }
    async downloadCurrentCodeEditorState() {
        const name = this.embeddedTutorialManager.tutorialId();
        await this.downloadManager.downloadCurrentStateOfTheSolution(name);
    }
    closeErrorsBox() {
        this.displayErrorsBox.set(false);
    }
    canDeleteFile(filename) {
        return !REQUIRED_FILES.has(filename);
    }
    async deleteFile(filename) {
        await this.codeMirrorEditor.deleteFile(filename);
        this.matTabGroup.selectedIndex = 0;
    }
    onAddButtonClick() {
        this.isCreatingFile.set(true);
        this.matTabGroup.selectedIndex = this.files().length;
    }
    async createFile(event) {
        if (!this.createFileInputRef)
            return;
        event.preventDefault();
        const newFileInputValue = this.createFileInputRef.nativeElement.value;
        if (newFileInputValue) {
            if (newFileInputValue.includes('..')) {
                alert('File name can not contain ".."');
                return;
            }
            // src is hidden from users, here we manually add it to the new filename
            const newFile = 'src/' + newFileInputValue;
            if (this.files().find(({ filename }) => filename.includes(newFile))) {
                alert('File already exists');
                return;
            }
            await this.codeMirrorEditor.createFile(newFile);
        }
        this.isCreatingFile.set(false);
    }
    listenToDiagnosticsChange() {
        this.errors$.subscribe((diagnostics) => {
            this.errors.set(diagnostics);
            this.displayErrorsBox.set(diagnostics.length > 0);
        });
    }
    setSelectedTabOnTutorialChange() {
        this.embeddedTutorialManager.tutorialChanged$
            .pipe(takeUntilDestroyed(this.destroyRef))
            .subscribe(() => {
            // selected file on project change is always the first
            this.matTabGroup.selectedIndex = 0;
        });
    }
    listenToTabChange() {
        this.matTabGroup.selectedIndexChange
            .pipe(takeUntilDestroyed(this.destroyRef))
            .subscribe((index) => {
            const selectedFile = this.files()[index];
            if (selectedFile) {
                this.codeMirrorEditor.changeCurrentFile(selectedFile.filename);
            }
        });
    }
}
CodeEditor.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.1.0-next.1", ngImport: i0, type: CodeEditor, deps: [], target: i0.ɵɵFactoryTarget.Component });
CodeEditor.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "17.1.0-next.1", type: CodeEditor, isStandalone: true, selector: "docs-tutorial-code-editor", viewQueries: [{ propertyName: "codeEditorWrapperRef", first: true, predicate: ["codeEditorWrapper"], descendants: true }, { propertyName: "matTabGroup", first: true, predicate: MatTabGroup, descendants: true }, { propertyName: "setFileInputRef", first: true, predicate: ["createFileInput"], descendants: true }], ngImport: i0, template: "<!-- Code Editor Tabs -->\n<div class=\"adev-code-editor-tabs\">\n  <div class=\"adev-tabs-and-plus\">\n    <mat-tab-group animationDuration=\"0ms\" mat-stretch-tabs=\"false\">\n      <!--\n        Hint: we would like to keep only one instance of #codeEditorWrapper,\n        that's why we're not placing this element as content of mat-tab, just to\n        not call another time init method from CodeMirrorEditor service.\n      -->\n      @for (file of files(); track file) {\n      <mat-tab #tab>\n        <ng-template mat-tab-label>\n          {{ file.filename.replace('src/', '') }}\n          @if (tab.isActive && canDeleteFile(file.filename)) {\n          <button\n            class=\"adev-delete-file\"\n            aria-label=\"Delete file\"\n            (click)=\"deleteFile(file.filename)\"\n          >\n            <docs-icon>delete</docs-icon>\n          </button>\n          }\n        </ng-template>\n      </mat-tab>\n      } @if (isCreatingFile()) {\n      <mat-tab>\n        <ng-template mat-tab-label>\n          <form (submit)=\"createFile($event)\">\n            <input\n              name=\"new-file\"\n              class=\"adev-new-file-input\"\n              #createFileInput\n              (keydown)=\"$event.stopPropagation()\"\n            />\n          </form>\n        </ng-template>\n      </mat-tab>\n      }\n    </mat-tab-group>\n\n    <button class=\"adev-add-file\" (click)=\"onAddButtonClick()\" aria-label=\"Add a new file\">\n      <docs-icon>add</docs-icon>\n    </button>\n  </div>\n\n  <button\n    class=\"adev-editor-download-button\"\n    type=\"button\"\n    (click)=\"downloadCurrentCodeEditorState()\"\n    aria-label=\"Download current code in editor\"\n  >\n    <docs-icon>download</docs-icon>\n  </button>\n</div>\n<!-- Code Editor -->\n<div #codeEditorWrapper class=\"adev-code-editor-wrapper\"></div>\n\n@if (displayErrorsBox()) {\n<div class=\"adev-inline-errors-box\">\n  <button type=\"button\" (click)=\"closeErrorsBox()\">\n    <docs-icon class=\"docs-icon_high-contrast\">close</docs-icon>\n  </button>\n  <ul>\n    @for (error of errors(); track error) {\n    <li>(line: {{ error.lineNumber }}:{{ error.characterPosition }}) {{ error.message }}</li>\n    }\n  </ul>\n</div>\n}\n", styles: [":host{--code-editor-selection-background: color-mix( in srgb, var(--selection-background) 5%, var(--octonary-contrast) );--code-editor-focused-selection-background: color-mix( in srgb, var(--selection-background) 12%, var(--octonary-contrast) );--code-editor-text-base-color: var(--primary-contrast);--code-editor-tooltip-background: color-mix( in srgb, var(--bright-blue), var(--page-background) 90% );--code-editor-tooltip-color: var(--primary-contrast);--code-editor-tooltip-border: 1px solid color-mix(in srgb, var(--bright-blue), var(--page-background) 70%);--code-editor-tooltip-border-radius: 0.25rem;--code-editor-autocomplete-item-background: var(--senary-contrast);--code-editor-autocomplete-item-color: var(--primary-contrast);--code-name: var(--primary-contrast);--code-editor-cursor-color: var(--code-name);--code-variable-name: var(--bright-blue);--code-property-name: var(--code-name);--code-definition-keyword: var(--electric-violet);--code-comment: var(--electric-violet);--code-line-comment: var(--symbolic-gray);--code-block-comment: var(--symbolic-brown);--code-doc-comment: var(--code-comment);--code-keyword: var(--electric-violet);--code-modifier: var(--code-keyword);--code-operator-keyword: var(--code-keyword);--code-control-keyword: var(--code-keyword);--code-module-keyword: var(--code-keyword);--code-brace: var(--vivid-pink);--code-bool: var(--bright-blue);--code-string: var(--orange-red);--code-regexp: var(--orange-red);--code-tags: var(--bright-blue);--code-component: var(--primary-contrast);--code-type-name: var(--vivid-pink);--code-self: var(--orange-red);position:relative}.adev-code-editor-tabs{display:flex;background:var(--octonary-contrast);border-block-end:1px solid var(--senary-contrast);transition:background .3s ease,border .3s ease}.adev-tabs-and-plus{display:flex;width:calc(100% - 2.875rem);min-height:48px}.adev-add-file docs-icon,.adev-delete-file docs-icon{color:var(--gray-400);transition:color .3s ease;font-size:1.2rem}.adev-add-file:hover docs-icon,.adev-delete-file:hover docs-icon{color:var(--primary-contrast)}.adev-delete-file{padding-inline-start:.1rem;padding-inline-end:0;margin-block-start:.2rem}.adev-delete-file docs-icon{font-size:1rem}.adev-new-file-input{color:var(--primary-contrast);border:none;border-radius:0;border-block-end:1px solid var(--senary-contrast);background:rgba(0,0,0,0);outline:none;transition:color .3s ease}.adev-new-file-input:focus{background:rgba(0,0,0,0);border-block-end:1px solid var(--primary-contrast)}.adev-code-editor-wrapper{height:calc(100% - 49px)}.adev-code-editor-wrapper-hidden{display:none}.adev-inline-errors-box{position:absolute;bottom:.5rem;left:.5rem;right:.5rem;padding:.25rem;background-color:color-mix(in srgb, var(--bright-blue), var(--page-background) 90%);border:1px solid color-mix(in srgb, var(--bright-blue), var(--page-background) 70%);border-radius:.25rem}.adev-inline-errors-box button{position:absolute;top:0;right:0;padding:.25rem}.adev-inline-errors-box button docs-icon{font-size:1.25rem;color:var(--quaternary-contrast);transition:color .3s ease}.adev-inline-errors-box button:hover docs-icon{color:var(--primary-contrast)}.adev-inline-errors-box ul{padding:0;margin:0;margin-inline:1.25rem;color:var(--tertiary-contrast);max-height:200px;overflow:auto}.adev-editor-download-button{padding:0;width:2.875rem;border-radius:0 .19rem 0 0;background:var(--octonary-contrast);border-inline-start:1px solid var(--senary-contrast)}.adev-editor-download-button docs-icon{color:var(--gray-400);transition:color .3s ease;font-size:1.3rem}.adev-editor-download-button:hover docs-icon{color:var(--primary-contrast)}/*# sourceMappingURL=code-editor.component.css.map */\n"], dependencies: [{ kind: "ngmodule", type: MatTabsModule }, { kind: "directive", type: i1.MatTabLabel, selector: "[mat-tab-label], [matTabLabel]" }, { kind: "component", type: i1.MatTab, selector: "mat-tab", inputs: ["disabled", "label", "aria-label", "aria-labelledby", "labelClass", "bodyClass"], exportAs: ["matTab"] }, { kind: "component", type: i1.MatTabGroup, selector: "mat-tab-group", inputs: ["color", "fitInkBarToContent", "mat-stretch-tabs", "dynamicHeight", "selectedIndex", "headerPosition", "animationDuration", "contentTabIndex", "disablePagination", "disableRipple", "preserveContent", "backgroundColor"], outputs: ["selectedIndexChange", "focusChange", "animationDone", "selectedTabChange"], exportAs: ["matTabGroup"] }, { kind: "component", type: IconComponent, selector: "docs-icon" }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.1.0-next.1", ngImport: i0, type: CodeEditor, decorators: [{
            type: Component,
            args: [{ selector: 'docs-tutorial-code-editor', standalone: true, changeDetection: ChangeDetectionStrategy.OnPush, imports: [NgIf, NgFor, MatTabsModule, IconComponent], template: "<!-- Code Editor Tabs -->\n<div class=\"adev-code-editor-tabs\">\n  <div class=\"adev-tabs-and-plus\">\n    <mat-tab-group animationDuration=\"0ms\" mat-stretch-tabs=\"false\">\n      <!--\n        Hint: we would like to keep only one instance of #codeEditorWrapper,\n        that's why we're not placing this element as content of mat-tab, just to\n        not call another time init method from CodeMirrorEditor service.\n      -->\n      @for (file of files(); track file) {\n      <mat-tab #tab>\n        <ng-template mat-tab-label>\n          {{ file.filename.replace('src/', '') }}\n          @if (tab.isActive && canDeleteFile(file.filename)) {\n          <button\n            class=\"adev-delete-file\"\n            aria-label=\"Delete file\"\n            (click)=\"deleteFile(file.filename)\"\n          >\n            <docs-icon>delete</docs-icon>\n          </button>\n          }\n        </ng-template>\n      </mat-tab>\n      } @if (isCreatingFile()) {\n      <mat-tab>\n        <ng-template mat-tab-label>\n          <form (submit)=\"createFile($event)\">\n            <input\n              name=\"new-file\"\n              class=\"adev-new-file-input\"\n              #createFileInput\n              (keydown)=\"$event.stopPropagation()\"\n            />\n          </form>\n        </ng-template>\n      </mat-tab>\n      }\n    </mat-tab-group>\n\n    <button class=\"adev-add-file\" (click)=\"onAddButtonClick()\" aria-label=\"Add a new file\">\n      <docs-icon>add</docs-icon>\n    </button>\n  </div>\n\n  <button\n    class=\"adev-editor-download-button\"\n    type=\"button\"\n    (click)=\"downloadCurrentCodeEditorState()\"\n    aria-label=\"Download current code in editor\"\n  >\n    <docs-icon>download</docs-icon>\n  </button>\n</div>\n<!-- Code Editor -->\n<div #codeEditorWrapper class=\"adev-code-editor-wrapper\"></div>\n\n@if (displayErrorsBox()) {\n<div class=\"adev-inline-errors-box\">\n  <button type=\"button\" (click)=\"closeErrorsBox()\">\n    <docs-icon class=\"docs-icon_high-contrast\">close</docs-icon>\n  </button>\n  <ul>\n    @for (error of errors(); track error) {\n    <li>(line: {{ error.lineNumber }}:{{ error.characterPosition }}) {{ error.message }}</li>\n    }\n  </ul>\n</div>\n}\n", styles: [":host{--code-editor-selection-background: color-mix( in srgb, var(--selection-background) 5%, var(--octonary-contrast) );--code-editor-focused-selection-background: color-mix( in srgb, var(--selection-background) 12%, var(--octonary-contrast) );--code-editor-text-base-color: var(--primary-contrast);--code-editor-tooltip-background: color-mix( in srgb, var(--bright-blue), var(--page-background) 90% );--code-editor-tooltip-color: var(--primary-contrast);--code-editor-tooltip-border: 1px solid color-mix(in srgb, var(--bright-blue), var(--page-background) 70%);--code-editor-tooltip-border-radius: 0.25rem;--code-editor-autocomplete-item-background: var(--senary-contrast);--code-editor-autocomplete-item-color: var(--primary-contrast);--code-name: var(--primary-contrast);--code-editor-cursor-color: var(--code-name);--code-variable-name: var(--bright-blue);--code-property-name: var(--code-name);--code-definition-keyword: var(--electric-violet);--code-comment: var(--electric-violet);--code-line-comment: var(--symbolic-gray);--code-block-comment: var(--symbolic-brown);--code-doc-comment: var(--code-comment);--code-keyword: var(--electric-violet);--code-modifier: var(--code-keyword);--code-operator-keyword: var(--code-keyword);--code-control-keyword: var(--code-keyword);--code-module-keyword: var(--code-keyword);--code-brace: var(--vivid-pink);--code-bool: var(--bright-blue);--code-string: var(--orange-red);--code-regexp: var(--orange-red);--code-tags: var(--bright-blue);--code-component: var(--primary-contrast);--code-type-name: var(--vivid-pink);--code-self: var(--orange-red);position:relative}.adev-code-editor-tabs{display:flex;background:var(--octonary-contrast);border-block-end:1px solid var(--senary-contrast);transition:background .3s ease,border .3s ease}.adev-tabs-and-plus{display:flex;width:calc(100% - 2.875rem);min-height:48px}.adev-add-file docs-icon,.adev-delete-file docs-icon{color:var(--gray-400);transition:color .3s ease;font-size:1.2rem}.adev-add-file:hover docs-icon,.adev-delete-file:hover docs-icon{color:var(--primary-contrast)}.adev-delete-file{padding-inline-start:.1rem;padding-inline-end:0;margin-block-start:.2rem}.adev-delete-file docs-icon{font-size:1rem}.adev-new-file-input{color:var(--primary-contrast);border:none;border-radius:0;border-block-end:1px solid var(--senary-contrast);background:rgba(0,0,0,0);outline:none;transition:color .3s ease}.adev-new-file-input:focus{background:rgba(0,0,0,0);border-block-end:1px solid var(--primary-contrast)}.adev-code-editor-wrapper{height:calc(100% - 49px)}.adev-code-editor-wrapper-hidden{display:none}.adev-inline-errors-box{position:absolute;bottom:.5rem;left:.5rem;right:.5rem;padding:.25rem;background-color:color-mix(in srgb, var(--bright-blue), var(--page-background) 90%);border:1px solid color-mix(in srgb, var(--bright-blue), var(--page-background) 70%);border-radius:.25rem}.adev-inline-errors-box button{position:absolute;top:0;right:0;padding:.25rem}.adev-inline-errors-box button docs-icon{font-size:1.25rem;color:var(--quaternary-contrast);transition:color .3s ease}.adev-inline-errors-box button:hover docs-icon{color:var(--primary-contrast)}.adev-inline-errors-box ul{padding:0;margin:0;margin-inline:1.25rem;color:var(--tertiary-contrast);max-height:200px;overflow:auto}.adev-editor-download-button{padding:0;width:2.875rem;border-radius:0 .19rem 0 0;background:var(--octonary-contrast);border-inline-start:1px solid var(--senary-contrast)}.adev-editor-download-button docs-icon{color:var(--gray-400);transition:color .3s ease;font-size:1.3rem}.adev-editor-download-button:hover docs-icon{color:var(--primary-contrast)}/*# sourceMappingURL=code-editor.component.css.map */\n"] }]
        }], propDecorators: { codeEditorWrapperRef: [{
                type: ViewChild,
                args: ['codeEditorWrapper']
            }], matTabGroup: [{
                type: ViewChild,
                args: [MatTabGroup]
            }], setFileInputRef: [{
                type: ViewChild,
                args: ['createFileInput']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1lZGl0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vZG9jcy9lZGl0b3IvY29kZS1lZGl0b3IvY29kZS1lZGl0b3IuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vZG9jcy9lZGl0b3IvY29kZS1lZGl0b3IvY29kZS1lZGl0b3IuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsT0FBTyxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsVUFBVSxFQUVWLFNBQVMsRUFDVCxNQUFNLEVBQ04sTUFBTSxHQUNQLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFBQyxXQUFXLEVBQUUsYUFBYSxFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFDbEUsT0FBTyxFQUFDLFlBQVksRUFBRSxHQUFHLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFFdkMsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLHNDQUFzQyxDQUFDO0FBQ2xFLE9BQU8sRUFBQyx1QkFBdUIsRUFBQyxNQUFNLCtDQUErQyxDQUFDO0FBRXRGLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLHVDQUF1QyxDQUFDO0FBQ3ZFLE9BQU8sRUFBeUIsZ0JBQWdCLEVBQUMsTUFBTSxzQ0FBc0MsQ0FBQztBQUM5RixPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sc0NBQXNDLENBQUM7QUFDckUsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLHNDQUFzQyxDQUFDOzs7QUFFbkUsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENB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QUFtQjtnQkFDRSxXQUFXO3NCQUExQyxTQUFTO3VCQUFDLFdBQVc7Z0JBR3NCLGVBQWU7c0JBQTFELFNBQVM7dUJBQUMsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuZGV2L2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge05nRm9yLCBOZ0lmfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENvbXBvbmVudCxcbiAgRGVzdHJveVJlZixcbiAgRWxlbWVudFJlZixcbiAgT25EZXN0cm95LFxuICBWaWV3Q2hpbGQsXG4gIGluamVjdCxcbiAgc2lnbmFsLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7dGFrZVVudGlsRGVzdHJveWVkfSBmcm9tICdAYW5ndWxhci9jb3JlL3J4anMtaW50ZXJvcCc7XG5pbXBvcnQge01hdFRhYkdyb3VwLCBNYXRUYWJzTW9kdWxlfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC90YWJzJztcbmltcG9ydCB7ZGVib3VuY2VUaW1lLCBtYXB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1Rlcm1pbmFsVHlwZX0gZnJvbSAnLi4vc2VydmljZXMvdGVybWluYWwtaGFuZGxlci5zZXJ2aWNlJztcbmltcG9ydCB7RW1iZWRkZWRUdXRvcmlhbE1hbmFnZXJ9IGZyb20gJy4uL3NlcnZpY2VzL2VtYmVkZGVkLXR1dG9yaWFsLW1hbmFnZXIuc2VydmljZSc7XG5cbmltcG9ydCB7Q29kZU1pcnJvckVkaXRvcn0gZnJvbSAnLi9zZXJ2aWNlcy9jb2RlLW1pcnJvci1lZGl0b3Iuc2VydmljZSc7XG5pbXBvcnQge0RpYWdub3N0aWNXaXRoTG9jYXRpb24sIERpYWdub3N0aWNzU3RhdGV9IGZyb20gJy4vc2VydmljZXMvZGlhZ25vc3RpY3Mtc3RhdGUuc2VydmljZSc7XG5pbXBvcnQge0Rvd25sb2FkTWFuYWdlcn0gZnJvbSAnLi4vc2VydmljZXMvZG93bmxvYWQtbWFuYWdlci5zZXJ2aWNlJztcbmltcG9ydCB7SWNvbkNvbXBvbmVudH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9pY29uL2ljb24uY29tcG9uZW50JztcblxuZXhwb3J0IGNvbnN0IFJFUVVJUkVEX0ZJTEVTID0gbmV3IFNldChbJ3NyYy9tYWluLnRzJywgJ3NyYy9pbmRleC5odG1sJ10pO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdkb2NzLXR1dG9yaWFsLWNvZGUtZWRpdG9yJyxcbiAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgdGVtcGxhdGVVcmw6ICcuL2NvZGUtZWRpdG9yLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vY29kZS1lZGl0b3IuY29tcG9uZW50LnNjc3MnXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIGltcG9ydHM6IFtOZ0lmLCBOZ0ZvciwgTWF0VGFic01vZHVsZSwgSWNvbkNvbXBvbmVudF0sXG59KVxuZXhwb3J0IGNsYXNzIENvZGVFZGl0b3IgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICBAVmlld0NoaWxkKCdjb2RlRWRpdG9yV3JhcHBlcicpIHByaXZhdGUgY29kZUVkaXRvcldyYXBwZXJSZWYhOiBFbGVtZW50UmVmPEhUTUxEaXZFbGVtZW50PjtcbiAgQFZpZXdDaGlsZChNYXRUYWJHcm91cCkgcHJpdmF0ZSBtYXRUYWJHcm91cCE6IE1hdFRhYkdyb3VwO1xuXG4gIHByaXZhdGUgY3JlYXRlRmlsZUlucHV0UmVmPzogRWxlbWVudFJlZjxIVE1MSW5wdXRFbGVtZW50PjtcbiAgQFZpZXdDaGlsZCgnY3JlYXRlRmlsZUlucHV0JykgcHJvdGVjdGVkIHNldCBzZXRGaWxlSW5wdXRSZWYoXG4gICAgZWxlbWVudDogRWxlbWVudFJlZjxIVE1MSW5wdXRFbGVtZW50PixcbiAgKSB7XG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIGVsZW1lbnQubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgICAgdGhpcy5jcmVhdGVGaWxlSW5wdXRSZWYgPSBlbGVtZW50O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveVJlZiA9IGluamVjdChEZXN0cm95UmVmKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGNvZGVNaXJyb3JFZGl0b3IgPSBpbmplY3QoQ29kZU1pcnJvckVkaXRvcik7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGlhZ25vc3RpY3NTdGF0ZSA9IGluamVjdChEaWFnbm9zdGljc1N0YXRlKTtcbiAgcHJpdmF0ZSByZWFkb25seSBkb3dubG9hZE1hbmFnZXIgPSBpbmplY3QoRG93bmxvYWRNYW5hZ2VyKTtcbiAgcHJpdmF0ZSByZWFkb25seSBlbWJlZGRlZFR1dG9yaWFsTWFuYWdlciA9IGluamVjdChFbWJlZGRlZFR1dG9yaWFsTWFuYWdlcik7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBlcnJvcnMkID0gdGhpcy5kaWFnbm9zdGljc1N0YXRlLmRpYWdub3N0aWNzJC5waXBlKFxuICAgIC8vIERpc3BsYXkgZXJyb3JzIG9uZSBzZWNvbmQgYWZ0ZXIgY29kZSB1cGRhdGVcbiAgICBkZWJvdW5jZVRpbWUoMTAwMCksXG4gICAgbWFwKChkaWFnbm9zdGljc0l0ZW0pID0+XG4gICAgICBkaWFnbm9zdGljc0l0ZW1cbiAgICAgICAgLmZpbHRlcigoaXRlbSkgPT4gaXRlbS5zZXZlcml0eSA9PT0gJ2Vycm9yJylcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+XG4gICAgICAgICAgYS5saW5lTnVtYmVyICE9IGIubGluZU51bWJlclxuICAgICAgICAgICAgPyBhLmxpbmVOdW1iZXIgLSBiLmxpbmVOdW1iZXJcbiAgICAgICAgICAgIDogYS5jaGFyYWN0ZXJQb3NpdGlvbiAtIGIuY2hhcmFjdGVyUG9zaXRpb24sXG4gICAgICAgICksXG4gICAgKSxcbiAgICB0YWtlVW50aWxEZXN0cm95ZWQodGhpcy5kZXN0cm95UmVmKSxcbiAgKTtcblxuICByZWFkb25seSBUZXJtaW5hbFR5cGUgPSBUZXJtaW5hbFR5cGU7XG5cbiAgcmVhZG9ubHkgZGlzcGxheUVycm9yc0JveCA9IHNpZ25hbDxib29sZWFuPihmYWxzZSk7XG4gIHJlYWRvbmx5IGVycm9ycyA9IHNpZ25hbDxEaWFnbm9zdGljV2l0aExvY2F0aW9uW10+KFtdKTtcbiAgcmVhZG9ubHkgZmlsZXMgPSB0aGlzLmNvZGVNaXJyb3JFZGl0b3Iub3BlbkZpbGVzO1xuICByZWFkb25seSBpc0NyZWF0aW5nRmlsZSA9IHNpZ25hbDxib29sZWFuPihmYWxzZSk7XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMuY29kZU1pcnJvckVkaXRvci5pbml0KHRoaXMuY29kZUVkaXRvcldyYXBwZXJSZWYubmF0aXZlRWxlbWVudCk7XG4gICAgdGhpcy5saXN0ZW5Ub0RpYWdub3N0aWNzQ2hhbmdlKCk7XG5cbiAgICB0aGlzLmxpc3RlblRvVGFiQ2hhbmdlKCk7XG4gICAgdGhpcy5zZXRTZWxlY3RlZFRhYk9uVHV0b3JpYWxDaGFuZ2UoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuY29kZU1pcnJvckVkaXRvci5kaXNhYmxlKCk7XG4gIH1cblxuICBhc3luYyBkb3dubG9hZEN1cnJlbnRDb2RlRWRpdG9yU3RhdGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgbmFtZSA9IHRoaXMuZW1iZWRkZWRUdXRvcmlhbE1hbmFnZXIudHV0b3JpYWxJZCgpO1xuICAgIGF3YWl0IHRoaXMuZG93bmxvYWRNYW5hZ2VyLmRvd25sb2FkQ3VycmVudFN0YXRlT2ZUaGVTb2x1dGlvbihuYW1lKTtcbiAgfVxuXG4gIGNsb3NlRXJyb3JzQm94KCk6IHZvaWQge1xuICAgIHRoaXMuZGlzcGxheUVycm9yc0JveC5zZXQoZmFsc2UpO1xuICB9XG5cbiAgY2FuRGVsZXRlRmlsZShmaWxlbmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuICFSRVFVSVJFRF9GSUxFUy5oYXMoZmlsZW5hbWUpO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlRmlsZShmaWxlbmFtZTogc3RyaW5nKSB7XG4gICAgYXdhaXQgdGhpcy5jb2RlTWlycm9yRWRpdG9yLmRlbGV0ZUZpbGUoZmlsZW5hbWUpO1xuICAgIHRoaXMubWF0VGFiR3JvdXAuc2VsZWN0ZWRJbmRleCA9IDA7XG4gIH1cblxuICBvbkFkZEJ1dHRvbkNsaWNrKCkge1xuICAgIHRoaXMuaXNDcmVhdGluZ0ZpbGUuc2V0KHRydWUpO1xuICAgIHRoaXMubWF0VGFiR3JvdXAuc2VsZWN0ZWRJbmRleCA9IHRoaXMuZmlsZXMoKS5sZW5ndGg7XG4gIH1cblxuICBhc3luYyBjcmVhdGVGaWxlKGV2ZW50OiBTdWJtaXRFdmVudCkge1xuICAgIGlmICghdGhpcy5jcmVhdGVGaWxlSW5wdXRSZWYpIHJldHVybjtcblxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICBjb25zdCBuZXdGaWxlSW5wdXRWYWx1ZSA9IHRoaXMuY3JlYXRlRmlsZUlucHV0UmVmLm5hdGl2ZUVsZW1lbnQudmFsdWU7XG5cbiAgICBpZiAobmV3RmlsZUlucHV0VmFsdWUpIHtcbiAgICAgIGlmIChuZXdGaWxlSW5wdXRWYWx1ZS5pbmNsdWRlcygnLi4nKSkge1xuICAgICAgICBhbGVydCgnRmlsZSBuYW1lIGNhbiBub3QgY29udGFpbiBcIi4uXCInKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBzcmMgaXMgaGlkZGVuIGZyb20gdXNlcnMsIGhlcmUgd2UgbWFudWFsbHkgYWRkIGl0IHRvIHRoZSBuZXcgZmlsZW5hbWVcbiAgICAgIGNvbnN0IG5ld0ZpbGUgPSAnc3JjLycgKyBuZXdGaWxlSW5wdXRWYWx1ZTtcblxuICAgICAgaWYgKHRoaXMuZmlsZXMoKS5maW5kKCh7ZmlsZW5hbWV9KSA9PiBmaWxlbmFtZS5pbmNsdWRlcyhuZXdGaWxlKSkpIHtcbiAgICAgICAgYWxlcnQoJ0ZpbGUgYWxyZWFkeSBleGlzdHMnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmNvZGVNaXJyb3JFZGl0b3IuY3JlYXRlRmlsZShuZXdGaWxlKTtcbiAgICB9XG5cbiAgICB0aGlzLmlzQ3JlYXRpbmdGaWxlLnNldChmYWxzZSk7XG4gIH1cblxuICBwcml2YXRlIGxpc3RlblRvRGlhZ25vc3RpY3NDaGFuZ2UoKTogdm9pZCB7XG4gICAgdGhpcy5lcnJvcnMkLnN1YnNjcmliZSgoZGlhZ25vc3RpY3MpID0+IHtcbiAgICAgIHRoaXMuZXJyb3JzLnNldChkaWFnbm9zdGljcyk7XG4gICAgICB0aGlzLmRpc3BsYXlFcnJvcnNCb3guc2V0KGRpYWdub3N0aWNzLmxlbmd0aCA+IDApO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRTZWxlY3RlZFRhYk9uVHV0b3JpYWxDaGFuZ2UoKSB7XG4gICAgdGhpcy5lbWJlZGRlZFR1dG9yaWFsTWFuYWdlci50dXRvcmlhbENoYW5nZWQkXG4gICAgICAucGlwZSh0YWtlVW50aWxEZXN0cm95ZWQodGhpcy5kZXN0cm95UmVmKSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAvLyBzZWxlY3RlZCBmaWxlIG9uIHByb2plY3QgY2hhbmdlIGlzIGFsd2F5cyB0aGUgZmlyc3RcbiAgICAgICAgdGhpcy5tYXRUYWJHcm91cC5zZWxlY3RlZEluZGV4ID0gMDtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBsaXN0ZW5Ub1RhYkNoYW5nZSgpIHtcbiAgICB0aGlzLm1hdFRhYkdyb3VwLnNlbGVjdGVkSW5kZXhDaGFuZ2VcbiAgICAgIC5waXBlKHRha2VVbnRpbERlc3Ryb3llZCh0aGlzLmRlc3Ryb3lSZWYpKVxuICAgICAgLnN1YnNjcmliZSgoaW5kZXgpID0+IHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWxlID0gdGhpcy5maWxlcygpW2luZGV4XTtcblxuICAgICAgICBpZiAoc2VsZWN0ZWRGaWxlKSB7XG4gICAgICAgICAgdGhpcy5jb2RlTWlycm9yRWRpdG9yLmNoYW5nZUN1cnJlbnRGaWxlKHNlbGVjdGVkRmlsZS5maWxlbmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG59XG4iLCI8IS0tIENvZGUgRWRpdG9yIFRhYnMgLS0+XG48ZGl2IGNsYXNzPVwiYWRldi1jb2RlLWVkaXRvci10YWJzXCI+XG4gIDxkaXYgY2xhc3M9XCJhZGV2LXRhYnMtYW5kLXBsdXNcIj5cbiAgICA8bWF0LXRhYi1ncm91cCBhbmltYXRpb25EdXJhdGlvbj1cIjBtc1wiIG1hdC1zdHJldGNoLXRhYnM9XCJmYWxzZVwiPlxuICAgICAgPCEtLVxuICAgICAgICBIaW50OiB3ZSB3b3VsZCBsaWtlIHRvIGtlZXAgb25seSBvbmUgaW5zdGFuY2Ugb2YgI2NvZGVFZGl0b3JXcmFwcGVyLFxuICAgICAgICB0aGF0J3Mgd2h5IHdlJ3JlIG5vdCBwbGFjaW5nIHRoaXMgZWxlbWVudCBhcyBjb250ZW50IG9mIG1hdC10YWIsIGp1c3QgdG9cbiAgICAgICAgbm90IGNhbGwgYW5vdGhlciB0aW1lIGluaXQgbWV0aG9kIGZyb20gQ29kZU1pcnJvckVkaXRvciBzZXJ2aWNlLlxuICAgICAgLS0+XG4gICAgICBAZm9yIChmaWxlIG9mIGZpbGVzKCk7IHRyYWNrIGZpbGUpIHtcbiAgICAgIDxtYXQtdGFiICN0YWI+XG4gICAgICAgIDxuZy10ZW1wbGF0ZSBtYXQtdGFiLWxhYmVsPlxuICAgICAgICAgIHt7IGZpbGUuZmlsZW5hbWUucmVwbGFjZSgnc3JjLycsICcnKSB9fVxuICAgICAgICAgIEBpZiAodGFiLmlzQWN0aXZlICYmIGNhbkRlbGV0ZUZpbGUoZmlsZS5maWxlbmFtZSkpIHtcbiAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICBjbGFzcz1cImFkZXYtZGVsZXRlLWZpbGVcIlxuICAgICAgICAgICAgYXJpYS1sYWJlbD1cIkRlbGV0ZSBmaWxlXCJcbiAgICAgICAgICAgIChjbGljayk9XCJkZWxldGVGaWxlKGZpbGUuZmlsZW5hbWUpXCJcbiAgICAgICAgICA+XG4gICAgICAgICAgICA8ZG9jcy1pY29uPmRlbGV0ZTwvZG9jcy1pY29uPlxuICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgIH1cbiAgICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICAgIDwvbWF0LXRhYj5cbiAgICAgIH0gQGlmIChpc0NyZWF0aW5nRmlsZSgpKSB7XG4gICAgICA8bWF0LXRhYj5cbiAgICAgICAgPG5nLXRlbXBsYXRlIG1hdC10YWItbGFiZWw+XG4gICAgICAgICAgPGZvcm0gKHN1Ym1pdCk9XCJjcmVhdGVGaWxlKCRldmVudClcIj5cbiAgICAgICAgICAgIDxpbnB1dFxuICAgICAgICAgICAgICBuYW1lPVwibmV3LWZpbGVcIlxuICAgICAgICAgICAgICBjbGFzcz1cImFkZXYtbmV3LWZpbGUtaW5wdXRcIlxuICAgICAgICAgICAgICAjY3JlYXRlRmlsZUlucHV0XG4gICAgICAgICAgICAgIChrZXlkb3duKT1cIiRldmVudC5zdG9wUHJvcGFnYXRpb24oKVwiXG4gICAgICAgICAgICAvPlxuICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICAgIDwvbWF0LXRhYj5cbiAgICAgIH1cbiAgICA8L21hdC10YWItZ3JvdXA+XG5cbiAgICA8YnV0dG9uIGNsYXNzPVwiYWRldi1hZGQtZmlsZVwiIChjbGljayk9XCJvbkFkZEJ1dHRvbkNsaWNrKClcIiBhcmlhLWxhYmVsPVwiQWRkIGEgbmV3IGZpbGVcIj5cbiAgICAgIDxkb2NzLWljb24+YWRkPC9kb2NzLWljb24+XG4gICAgPC9idXR0b24+XG4gIDwvZGl2PlxuXG4gIDxidXR0b25cbiAgICBjbGFzcz1cImFkZXYtZWRpdG9yLWRvd25sb2FkLWJ1dHRvblwiXG4gICAgdHlwZT1cImJ1dHRvblwiXG4gICAgKGNsaWNrKT1cImRvd25sb2FkQ3VycmVudENvZGVFZGl0b3JTdGF0ZSgpXCJcbiAgICBhcmlhLWxhYmVsPVwiRG93bmxvYWQgY3VycmVudCBjb2RlIGluIGVkaXRvclwiXG4gID5cbiAgICA8ZG9jcy1pY29uPmRvd25sb2FkPC9kb2NzLWljb24+XG4gIDwvYnV0dG9uPlxuPC9kaXY+XG48IS0tIENvZGUgRWRpdG9yIC0tPlxuPGRpdiAjY29kZUVkaXRvcldyYXBwZXIgY2xhc3M9XCJhZGV2LWNvZGUtZWRpdG9yLXdyYXBwZXJcIj48L2Rpdj5cblxuQGlmIChkaXNwbGF5RXJyb3JzQm94KCkpIHtcbjxkaXYgY2xhc3M9XCJhZGV2LWlubGluZS1lcnJvcnMtYm94XCI+XG4gIDxidXR0b24gdHlwZT1cImJ1dHRvblwiIChjbGljayk9XCJjbG9zZUVycm9yc0JveCgpXCI+XG4gICAgPGRvY3MtaWNvbiBjbGFzcz1cImRvY3MtaWNvbl9oaWdoLWNvbnRyYXN0XCI+Y2xvc2U8L2RvY3MtaWNvbj5cbiAgPC9idXR0b24+XG4gIDx1bD5cbiAgICBAZm9yIChlcnJvciBvZiBlcnJvcnMoKTsgdHJhY2sgZXJyb3IpIHtcbiAgICA8bGk+KGxpbmU6IHt7IGVycm9yLmxpbmVOdW1iZXIgfX06e3sgZXJyb3IuY2hhcmFjdGVyUG9zaXRpb24gfX0pIHt7IGVycm9yLm1lc3NhZ2UgfX08L2xpPlxuICAgIH1cbiAgPC91bD5cbjwvZGl2PlxufVxuIl19